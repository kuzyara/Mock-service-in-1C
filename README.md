# Mock-service-in-1C
[![telegram](https://patrolavia.github.io/telegram-badge/chat.png)](https://teleg.run/kuzyara777)

Утилита подняния мок-сервиса из файла soap.ui

```console
C:\jenkins-slave\uat-price\soapui.net\bin>StandardConsoleApp.exe /?
start [/F Filepath] [/S Filepath] [/T:timeout]
/F                   Set XML SoapUI Project, by default using "project.xml" in root directory.
Filepath             Full filepath.
/S                   Set stop file if need to shut down server by file.
Filepath             Full filepath.
/T:timeout           Timeout in seconds if need to shut down server by timeout.
```
 Реализация:  
```bsl
Процедура ПоднятьМоки(ДвоичныеДанныеХМЛ, ИмяВыключателя, Лог = Неопределено, Таймаут = 60) Экспорт
	ПутьКХМЛ		= ПолучитьИмяВременногоФайла("xml");
	ДвоичныеДанныеХМЛ.Записать(ПутьКХМЛ);
	Сообщить("Путь к ХМЛ: " + ПутьКХМЛ);
	Шелл			= Новый COMОбъект("WScript.Shell");
	
	ПолныйПутьКЗапускателю = Константы.ПутьКЗапускателюЗаглушекВебСервисов.Получить();
	Если НЕ ЗначениеЗаполнено(ПолныйПутьКЗапускателю) Тогда
		ПутьКОбертке = НайтиОбертку();
		КомандаШелла	= "java -classpath " + ПутьКОбертке + "SoapUIWrapper.jar;" + ПутьКОбертке + "lib\* com.norg.wrapper.Main """ + ПутьКХМЛ + """ """ + (КаталогВременныхФайлов() + ИмяВыключателя) + """" +" "+XMLСтрока(Таймаут)+ "> """ + КаталогВременныхФайлов() + "log.txt"" 2>&1";
	Иначе
		ЗапускательОбертки = ПолныйПутьКЗапускателю + " start";
		КомандаШелла	   = ЗапускательОбертки + " /F """+ПутьКХМЛ+""" /T:"+XMLСтрока(Таймаут)+" /s """+  (КаталогВременныхФайлов() + ИмяВыключателя) + """";
	КонецЕсли;
	Батник = Новый ТекстовыйДокумент;
	Батник.УстановитьТекст(КомандаШелла);
	Батник.Записать(КаталогВременныхФайлов() + "start.bat", КодировкаТекста.ANSI);
	Сообщить(КомандаШелла);
	Результат		= Шелл.Run("""" + КаталогВременныхФайлов() + "start.bat""", 1, Истина);
	
	Начало = ТекущаяУниверсальнаяДатаВМиллисекундах();
	Длительность = 0;
	Пока Длительность <= 25 Цикл
		Длительность = (ТекущаяУниверсальнаяДатаВМиллисекундах()-Начало)/1000;
	КонецЦикла;
КонецПроцедуры

Процедура ЗавершитьМоки(ИмяВыключателя, Лог = Неопределено) Экспорт
	ТД = Новый ТекстовыйДокумент;
	ТД.Записать(КаталогВременныхФайлов()+ИмяВыключателя);
	Попытка
		Лог = Новый ДвоичныеДанные(КаталогВременныхФайлов() + "log.txt");
	Исключение
	КонецПопытки;
КонецПроцедуры

Процедура ПоднятьМокиВФоне(ДвоичныеДанныеХМЛ, ИмяВыключателя, Лог = Неопределено, Таймаут = 60) Экспорт
	Парам = Новый Массив;
	Парам.Добавить(ДвоичныеДанныеХМЛ);
	Парам.Добавить(ИмяВыключателя);
	Парам.Добавить(Лог);
	Парам.Добавить(Таймаут);
	ФоновыеЗадания.Выполнить("Тестирование.ПоднятьМоки", Парам);
КонецПроцедуры
```
Пример использования:
```gherkin
Функционал: Синхронизация ограничений по минимальной цене для брендов с системой фронт 
            Как разработчик  
            Я хочу синхронизировать ограничения по минимальной цене с системой фронт
            Чтобы не изменять код конфигурации при изменении ограничений

Контекст:
	Дано Существует метаданное "Справочник.Производители"
    И Я Очищаю Справочник "Производители"
    И Я Очищаю Справочник "СинтетическиеГруппы"
    И Я Очищаю РегистрСведений "ОчередьВыгрузкиСправочниковВоФронт"
    И Существует метаданное "ПодпискаНаСобытие.РегистрацияИзмененийСправочников"
    И Существует метаданное "РегистрСведений.ОчередьВыгрузкиСправочниковВоФронт"
    И Существует фоновое задание ЦО "ВыгрузкаСправочниковВоФронт"
    И Создан тестовый элемент справочника Производители
    И Существует предопределенный элемент справочника "СоответствиеВебСервисов" "ФРОНТВыгрузкаСправочников"

Сценарий: Выгрузка измений во Фронт по требованию
    Когда в справочнике СоответствиеВебСервисов установлены настройки для отправки в мок-сервис
    И    Поднять Мок сервисы на сервере в фоне "mockFrontBrand.xml" с таймаутом "140" 
    И    Ожидаю поднятия мок сервисов справочника "СоответствиеВебСервисов" из таблицы:
	|'Наименование'			  			  |'Предопределенный'|
	|'ФРОНТВыгрузкаСправочников'	  	  |'Истина'			 |
    И     Настроено фоновое задание выгрузки справочников во Фронт
    И     в регистре ОчередьВыгрузкиСправочниковВоФронт появилась запись с тестовым справочником 
    И     Я инициирую выгрузку данных во фронт   
    Тогда регистр Очередь ВыгрузкиСправочниковВоФронт стал пустым
	И 	  Завершить мок сервисы на сервере
```
